name: Deploy to EC2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Flask SQLAlchemy WTForms
    
    - name: Run basic tests
      run: |
        python -c "
        try:
            import flask, sqlalchemy, wtforms
            print('âœ… All core dependencies imported successfully')
            
            # Test basic Flask app creation
            from flask import Flask
            app = Flask(__name__)
            print('âœ… Flask app creation test passed')
            
            # Test SQLAlchemy import
            from sqlalchemy import create_engine
            print('âœ… SQLAlchemy import test passed')
            
            print('âœ… All tests passed successfully!')
            
        except ImportError as e:
            print(f'âŒ Import error: {e}')
            exit(1)
        except Exception as e:
            print(f'âŒ Test error: {e}')
            exit(1)
        "

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          # First, ensure all required software is installed
          echo "ğŸ”§ Setting up required software..."
          
          # Detect OS and set package manager
          if command -v apt &> /dev/null; then
            PKG_MANAGER="apt"
            UPDATE_CMD="sudo apt update -y"
            INSTALL_CMD="sudo apt install -y"
          elif command -v yum &> /dev/null; then
            PKG_MANAGER="yum"
            UPDATE_CMD="sudo yum update -y"
            INSTALL_CMD="sudo yum install -y"
          elif command -v dnf &> /dev/null; then
            PKG_MANAGER="dnf"
            UPDATE_CMD="sudo dnf update -y"
            INSTALL_CMD="sudo dnf install -y"
          else
            echo "âŒ Unsupported package manager. Please install Git and Docker manually."
            exit 1
          fi
          
          echo "ğŸ“‹ Detected package manager: $PKG_MANAGER"
          
          # Update system
          echo "ğŸ”„ Updating system packages..."
          $UPDATE_CMD
          
          # Install Git if not present
          if ! command -v git &> /dev/null; then
            echo "ğŸ“¦ Installing Git..."
            $INSTALL_CMD git
          else
            echo "âœ… Git is already installed"
          fi
          
          # Install Docker if not present
          if ! command -v docker &> /dev/null; then
            echo "ğŸ³ Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            sudo usermod -aG docker $USER
            rm get-docker.sh
            echo "âœ… Docker installed successfully"
          else
            echo "âœ… Docker is already installed"
          fi
          
          # Install Docker Compose if not present
          if ! command -v docker-compose &> /dev/null; then
            echo "ğŸ”§ Installing Docker Compose..."
            if [ "$PKG_MANAGER" = "apt" ]; then
              $INSTALL_CMD docker-compose
            else
              # For RHEL/CentOS/Amazon Linux, install via pip or direct download
              if command -v pip3 &> /dev/null; then
                sudo pip3 install docker-compose
              else
                # Install pip first, then docker-compose
                $INSTALL_CMD python3-pip
                sudo pip3 install docker-compose
              fi
            fi
            echo "âœ… Docker Compose installed successfully"
          else
            echo "âœ… Docker Compose is already installed"
          fi
          
          # Ensure Docker service is running
          echo "ğŸ”„ Starting Docker service..."
          sudo systemctl start docker
          sudo systemctl enable docker
          
          # Add user to docker group (for future commands)
          sudo usermod -aG docker $USER
          
          # Navigate to project directory
          cd /home/${{ secrets.EC2_USERNAME }}/adarsh-app || {
            echo "âŒ Project directory not found. Creating it..."
            mkdir -p /home/${{ secrets.EC2_USERNAME }}/adarsh-app
            cd /home/${{ secrets.EC2_USERNAME }}/adarsh-app
          }
          
          # Clone or pull latest code
          if [ -d ".git" ]; then
            echo "ğŸ”„ Pulling latest changes..."
            git pull origin main || git pull origin master
          else
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/rushi-mereddy/adarsh-app.git .
          fi
          
          # Create .env file if it doesn't exist
          if [ ! -f ".env" ]; then
            echo "ğŸ“ Creating .env file..."
            cat > .env << 'EOF'
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          SESSION_SECRET=${{ secrets.SESSION_SECRET }}
          FLASK_ENV=production
          DOMAIN=${{ secrets.DOMAIN }}
          EOF
          fi
          
          # Create necessary directories
          mkdir -p static/uploads ssl
          chmod 755 static/uploads
          
          # Stop existing services
          echo "ğŸ›‘ Stopping existing services..."
          sudo docker-compose -f docker-compose.prod.yml down || true
          
          # Remove old images to free space
          echo "ğŸ§¹ Cleaning up old Docker images..."
          sudo docker system prune -f || true
          
          # Build and start services
          echo "ğŸš€ Building and starting services..."
          sudo docker-compose -f docker-compose.prod.yml build --no-cache
          sudo docker-compose -f docker-compose.prod.yml up -d
          
          # Wait for services to be ready
          echo "â³ Waiting for services to start..."
          sleep 30
          
          # Initialize database
          echo "ğŸ—„ï¸ Initializing database..."
          sudo docker-compose -f docker-compose.prod.yml exec -T web python -c "
          from app import app, db
          from models import User
          from werkzeug.security import generate_password_hash
          
          with app.app_context():
              try:
                  print('ğŸ”„ Creating database tables...')
                  db.create_all()
                  print('âœ… Database tables created successfully!')
                  
                  # Create admin user if not exists
                  admin = User.query.filter_by(email='admin@college.edu').first()
                  if not admin:
                      admin_user = User(
                          first_name='System',
                          last_name='Administrator', 
                          email='admin@college.edu',
                          password=generate_password_hash('admin123'),
                          role='admin',
                          is_active=True,
                          phone='1234567890',
                          department='Administration'
                      )
                      db.session.add(admin_user)
                      db.session.commit()
                      print('âœ… Admin user created: admin@college.edu / admin123')
                  else:
                      print('â„¹ï¸ Admin user already exists')
                      
              except Exception as e:
                  print(f'âŒ Database initialization error: {e}')
          " || echo "âš ï¸ Database initialization failed, but continuing..."
          
          # Health check
          echo "ğŸ” Performing health check..."
          sleep 10
          
          if curl -f http://localhost/health > /dev/null 2>&1; then
            echo "âœ… Deployment successful! Application is running."
            
            # Show service status
            echo "ğŸ“Š Service Status:"
            sudo docker-compose -f docker-compose.prod.yml ps
            
            # Show recent logs
            echo "ğŸ“‹ Recent logs:"
            sudo docker-compose -f docker-compose.prod.yml logs --tail=20
            
          else
            echo "âŒ Health check failed. Showing logs for debugging:"
            sudo docker-compose -f docker-compose.prod.yml logs
            exit 1
          fi

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify deployment status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Application URL: http://${{ secrets.EC2_HOST }}"
          echo "ğŸ‘¤ Admin Login: admin@college.edu / admin123"
        else
          echo "âŒ Deployment failed!"
        fi
